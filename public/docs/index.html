<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Almacen Principal — Documentación</title>
  <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5/swagger-ui.css" />
  <style>
    body { margin: 0; background: #e5e7eb; }
    .topbar { display: none; }
    #swagger-ui { max-width: 1200px; margin: 0 auto; }
  </style>
</head>
  <body>
    <div id="swagger-ui"></div>
    <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js" crossorigin></script>
    <script>
      const specUrl = './openapi.yaml?v=' + (new Date()).getTime();
      window.ui = SwaggerUIBundle({
        url: specUrl,
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [SwaggerUIBundle.presets.apis],
        layout: 'BaseLayout'
      });

      // Inserta widget dentro del opblock GET /api/hospitales
      function buildWidget() {
        const wrap = document.createElement('div');
        wrap.style.margin = '8px 0 0 0';
        wrap.style.padding = '8px';
        wrap.style.background = '#f8fafc';
        wrap.style.border = '1px solid #e2e8f0';
        wrap.style.borderRadius = '6px';
        wrap.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <strong>Ruta rápida:</strong>
            <label>Status
              <select id="statusSelDocs" style="padding:6px 8px;border:1px solid #cbd5e1;border-radius:6px">
                <option value="activo" selected>activo (default)</option>
                <option value="inactivo">inactivo</option>
                <option value="all">all</option>
              </select>
            </label>
            <code id="builtTextDocs" style="padding:4px 6px;background:#fff;border:1px solid #e2e8f0;border-radius:6px">/api/hospitales</code>
            <button id="copyBtnDocs" title="Copiar" style="padding:6px 10px;border:1px solid #cbd5e1;border-radius:6px;background:#f1f5f9;cursor:pointer">Copiar</button>
          </div>
          <div style="margin-top:6px;font-size:12px;color:#334155">Consejo: "activo" es el valor por defecto; si seleccionas "activo" no se añade query param.</div>
        `;
        return wrap;
      }

      function updatePath() {
        const sel = document.getElementById('statusSelDocs');
        if (!sel) return;
        const val = sel.value;
        const path = val === 'activo' ? '/api/hospitales' : `/api/hospitales?status=${encodeURIComponent(val)}`;
        const code = document.getElementById('builtTextDocs');
        if (code) code.textContent = path;
      }

      function injectIntoHospitalsOp() {
        const blocks = document.querySelectorAll('#swagger-ui .opblock');
        for (const b of blocks) {
          const methodEl = b.querySelector('.opblock-summary-method');
          const pathEl = b.querySelector('.opblock-summary-path');
          if (!methodEl || !pathEl) continue;
          if (methodEl.textContent.trim().toUpperCase() === 'GET' && pathEl.textContent.trim() === '/api/hospitales') {
            const body = b.querySelector('.opblock-body');
            // Dentro del despliegue: contenido principal del body
            const bodyContent = b.querySelector('.opblock-body .opblock-section .opblock-section-content') || body;
            if (bodyContent && !bodyContent.querySelector('#statusSelDocs')) {
              const widget = buildWidget();
              bodyContent.appendChild(widget);
              // Eventos
              bodyContent.querySelector('#statusSelDocs').addEventListener('change', updatePath);
              bodyContent.querySelector('#copyBtnDocs').addEventListener('click', function(){
                const txt = bodyContent.querySelector('#builtTextDocs').textContent;
                navigator.clipboard.writeText(txt).then(()=>{
                  const btn = bodyContent.querySelector('#copyBtnDocs');
                  const old = btn.textContent;
                  btn.textContent = 'Copiado';
                  setTimeout(()=> btn.textContent = old, 1200);
                });
              });
              updatePath();
              return true;
            }
            // Si aún no hay body (no desplegado), añadir listener para inyectar tras el click
            const summary = b.querySelector('.opblock-summary');
            if (summary && !b.classList.contains('is-open')) {
              summary.addEventListener('click', () => {
                // esperar a que se renderice el body
                setTimeout(() => injectIntoHospitalsOp(), 100);
              }, { once: true });
            }
          }
        }
        return false;
      }

      // Intentar inyección tras render
      const tryInject = () => {
        if (injectIntoHospitalsOp()) return;
        // Observar cambios para reintentar cuando Swagger expanda secciones
        const root = document.getElementById('swagger-ui');
        const obs = new MutationObserver(() => {
          if (injectIntoHospitalsOp()) {
            obs.disconnect();
          }
        });
        obs.observe(root, { childList: true, subtree: true });
      };
      // Dar un pequeño tiempo a la carga inicial
      setTimeout(tryInject, 400);
    </script>
  </body>
</html>
